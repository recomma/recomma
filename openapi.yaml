openapi: 3.0.3
info:
  title: Recomma Ops API
  version: 0.2.1
  license:
    name: Apache 2.0
    url: https://github.com/terwey/recomma/blob/main/LICENSE.txt

servers:
  - url: http://localhost:8080
security:
  - SessionCookie: []
paths:
  /webauthn/registration/begin:
    post:
      operationId: beginWebauthnRegistration
      summary: Begin WebAuthn registration
      description: >
        Issues a WebAuthn credential creation challenge for the supplied username. Clients must
        pass the returned options to `navigator.credentials.create` and later submit the authenticator
        response to `/webauthn/registration/finish`.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnRegistrationBeginRequest'
      responses:
        '200':
          description: Registration ceremony started; includes session token and creation options.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnRegistrationBeginResponse'
        '400':
          description: Invalid payload
        '409':
          description: Registration not allowed in current vault state
        '500':
          description: Internal server error

  /webauthn/registration/finish:
    post:
      operationId: finishWebauthnRegistration
      summary: Complete WebAuthn registration
      description: >
        Validates the WebAuthn attestation returned by the authenticator and stores the credential for
        the vault user. The supplied session token must match a previous registration begin call.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnRegistrationFinishRequest'
      responses:
        '200':
          description: Registration completed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnRegistrationFinishResponse'
        '400':
          description: Invalid attestation payload
        '404':
          description: Registration session not found or expired
        '409':
          description: Registration not allowed in current vault state
        '500':
          description: Internal server error

  /webauthn/login/begin:
    post:
      operationId: beginWebauthnLogin
      summary: Begin WebAuthn assertion
      description: >
        Issues a WebAuthn assertion challenge for the supplied username. Clients must forward the
        returned options to `navigator.credentials.get` and later submit the authenticator response to
        `/webauthn/login/finish`.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnLoginBeginRequest'
      responses:
        '200':
          description: Login ceremony started; includes session token and assertion options.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnLoginBeginResponse'
        '400':
          description: Invalid payload
        '404':
          description: No WebAuthn credentials available for the user
        '409':
          description: Login not allowed in current vault state
        '500':
          description: Internal server error

  /webauthn/login/finish:
    post:
      operationId: finishWebauthnLogin
      summary: Complete WebAuthn assertion
      description: >
        Validates the WebAuthn assertion and issues an authenticated session cookie for the vault endpoints.
        The supplied session token must match a previous login begin call.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnLoginFinishRequest'
      responses:
        '200':
          description: Login completed successfully; session cookie returned.
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Session cookie (`recomma_session`) representing the authenticated user.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnLoginFinishResponse'
        '400':
          description: Invalid assertion payload
        '404':
          description: Login session not found or expired
        '409':
          description: Login not allowed in current vault state
        '500':
          description: Internal server error
  /vault/status:
    get:
      security: []
      operationId: getVaultStatus
      summary: Inspect vault state
      description: >
        Returns the current vault lifecycle state plus metadata about the active user
        and session. This endpoint is unauthenticated so the frontend can poll during setup.
      responses:
        '200':
          description: Current vault status.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '500':
          description: Internal server error

  /vault/setup:
    post:
      security: []
      operationId: setupVault
      summary: Store the encrypted vault payload
      description: >
        Accepts the username and WebAuthn PRF-encrypted secret bundle produced by the browser.
        After storing the payload the vault transitions to the sealed state and awaits unseal.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VaultSetupRequest'
      responses:
        '201':
          description: Vault payload stored; service is sealed and ready for unseal.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '400':
          description: Invalid payload; rejected.
        '409':
          description: Vault is already initialized; switch to recovery flow.
        '500':
          description: Internal server error

  /vault/unseal:
    post:
      security: []
      operationId: unsealVault
      summary: Provide decrypted secrets to unlock the vault
      description: >
        Accepts the plaintext bundle derived in the browser after WebAuthn verification.
        On success the server hydrates upstream clients, issues a session cookie, and marks
        the vault as unsealed until the session expires or `/vault/seal` is called.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VaultUnsealRequest'
      responses:
        '200':
          description: Vault unsealed; session cookie returned.
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Session cookie (`recomma_session`) representing the authenticated user.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '400':
          description: Payload rejected.
        '409':
          description: Vault must be sealed before unsealing.
        '423':
          description: Initial setup is still required.
        '500':
          description: Internal server error

  /vault/seal:
    post:
      operationId: sealVault
      summary: Reseal the vault and clear in-memory secrets
      description: >
        Marks the vault as sealed, drops in-memory credentials, and invalidates the current session.
      responses:
        '200':
          description: Vault sealed; upstream activity should pause until unsealed again.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '401':
          description: Authentication required.
        '500':
          description: Internal server error
      security:
        - SessionCookie: []

  /vault/payload:
    get:
      operationId: getVaultPayload
      summary: Retrieve encrypted vault payload
      description: >
        Returns the stored ciphertext bundle for the authenticated user. Requires a
        valid session cookie obtained via WebAuthn and is typically called immediately
        before `/vault/unseal`.
      responses:
        '200':
          description: Ciphertext payload available for decryption in the browser.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultEncryptedPayload'
        '401':
          description: Authentication required.
        '404':
          description: No vault payload stored yet (setup required or recovery mode).
        '423':
          description: Vault is not yet initialized; run `/vault/setup` first.
        '500':
          description: Internal server error
      security:
        - SessionCookie: []
  /api/bots:
    get:
      operationId: listBots
      summary: List cached 3Commas bots
      description: >
        Returns bot records stored in `threecommas_bots`. Use filters to drill down
        to a single bot if needed.
      parameters:
        - name: bot_id
          in: query
          description: Return only the bot with this ID (exact match).
          required: false
          schema:
            type: integer
            format: int64
        - name: updated_from
          in: query
          description: ISO-8601 timestamp; include bots touched at or after this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: updated_to
          in: query
          description: ISO-8601 timestamp; include bots touched at or before this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of rows (default 100, max 500).
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 500
        - name: page_token
          in: query
          description: Opaque cursor returned by a previous call (empty for first page).
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Bot records ordered newest-first unless a chronological range was requested.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/BotRecord'
                  next_page_token:
                    type: string
                    nullable: true
                required:
                  - items
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /api/deals:
    get:
      operationId: listDeals
      summary: List cached 3Commas deals
      description: >
        Returns deal rows from `threecommas_deals`. Filters allow narrowing by bot,
        deal ID, and update timestamps; a single endpoint covers both list and detail use-cases.
      parameters:
        - name: deal_id
          in: query
          description: Return only the deal with this ID (exact match).
          required: false
          schema:
            type: integer
            format: int64
        - name: bot_id
          in: query
          description: Restrict to deals belonging to this bot.
          required: false
          schema:
            type: integer
            format: int64
        - name: updated_from
          in: query
          description: ISO-8601 timestamp; include deals updated at or after this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: updated_to
          in: query
          description: ISO-8601 timestamp; include deals updated at or before this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of rows (default 100, max 500).
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 500
        - name: page_token
          in: query
          description: Opaque cursor returned by a previous call.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Deal records ordered newest-first unless a chronological range was requested.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DealRecord'
                  next_page_token:
                    type: string
                    nullable: true
                required:
                  - items
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /api/orders:
    get:
      operationId: listOrders
      summary: List acted-on bot events with Hyperliquid context
      description: >
        Returns rows from `threecommas_botevents` (the actionable subset). Each row includes the raw
        3Commas payload, plus the latest matching submission and status from Hyperliquid if present.
        Use the filters to drill down to a single metadata hex, bot, deal, or bot-event ID.
        The `from`/`to` window operates on the bot-event `observed_at` timestamp so you can page through history.
        Setting `include_log=true` embeds matching entries from `threecommas_botevents_log` and
        `hyperliquid_status_history` within each result, filtered by the same time window.
      parameters:
        - name: metadata
          in: query
          description: Case-insensitive prefix match on metadata hex; exact match recommended for drill-down.
          required: false
          schema:
            type: string
        - name: bot_id
          in: query
          description: Restrict to events emitted by this bot ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: deal_id
          in: query
          description: Restrict to events emitted by this deal ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: bot_event_id
          in: query
          description: Restrict to a specific 3Commas bot-event ID (exact match).
          required: false
          schema:
            type: integer
            format: int64
        - name: observed_from
          in: query
          description: ISO-8601 timestamp; include events observed at or after this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: observed_to
          in: query
          description: ISO-8601 timestamp; include events observed at or before this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: include_log
          in: query
          description: >
            When true, embed `log_entries` for each order, limited to the same metadata and
            time range (default false).
          required: false
          schema:
            type: boolean
        - name: limit
          in: query
          description: Maximum number of rows (default 100, max 500).
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 500
        - name: page_token
          in: query
          description: Opaque cursor returned by a previous call.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Order records matching the requested filters.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderRecord'
                  next_page_token:
                    type: string
                    nullable: true
                required:
                  - items
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /sse/orders:
    get:
      operationId: streamOrders
      summary: Stream live changes to acted-on orders
      description: >
        Server Sent Events channel fed by writes to `threecommas_botevents`, `hyperliquid_submissions`,
        and `hyperliquid_status_history`. Each `data:` frame is a JSON object containing the raw payload
        we stored for that update, plus the metadata hex and timestamps. Filters match the query semantics
        of `/api/orders`.
      parameters:
        - name: metadata
          in: query
          description: Case-insensitive prefix match; only events for matching metadata are emitted.
          required: false
          schema:
            type: string
        - name: bot_id
          in: query
          description: Restrict to this bot ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: deal_id
          in: query
          description: Restrict to this deal ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: bot_event_id
          in: query
          description: Restrict to this bot-event ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: observed_from
          in: query
          description: If supplied, drop events older than this timestamp (useful for resume).
          required: false
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: text/event-stream; each frame carries a JSON object with order-change details.
          content:
            text/event-stream:
              schema:
                type: string
                description: >
                  UTF-8 event stream. Example frame:
                  ```
                  event: three_commas_event
                  data: {"type":"three_commas_event","metadata_hex":"0x1234","observed_at":"2025-01-02T03:04:05Z","payload":{...}}
                  
                  ```
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

components:
  securitySchemes:
    SessionCookie:
      type: apiKey
      in: cookie
      name: recomma_session
      description: Session cookie issued after a successful `/vault/unseal`.

  schemas:
    WebAuthnRegistrationBeginRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          description: Logical username initiating registration.

    WebAuthnRegistrationBeginResponse:
      type: object
      required:
        - session_token
        - creation_options
      properties:
        session_token:
          type: string
          description: Opaque token that must be supplied when completing registration.
        creation_options:
          type: object
          additionalProperties: true
          description: PublicKeyCredentialCreationOptions for `navigator.credentials.create`.

    WebAuthnRegistrationFinishRequest:
      type: object
      required:
        - session_token
        - client_response
      properties:
        session_token:
          type: string
          description: Token issued by `/webauthn/registration/begin`.
        client_response:
          type: object
          additionalProperties: true
          description: Parsed response from `navigator.credentials.create`.

    WebAuthnRegistrationFinishResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Textual status of the registration ceremony (for example `registered`).

    WebAuthnLoginBeginRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          description: Logical username initiating the login ceremony.

    WebAuthnLoginBeginResponse:
      type: object
      required:
        - session_token
        - assertion_options
      properties:
        session_token:
          type: string
          description: Opaque token that must be supplied when completing login.
        assertion_options:
          type: object
          additionalProperties: true
          description: PublicKeyCredentialRequestOptions for `navigator.credentials.get`.

    WebAuthnLoginFinishRequest:
      type: object
      required:
        - session_token
        - client_response
      properties:
        session_token:
          type: string
          description: Token issued by `/webauthn/login/begin`.
        client_response:
          type: object
          additionalProperties: true
          description: Parsed response from `navigator.credentials.get`.

    WebAuthnLoginFinishResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Textual status of the login ceremony (for example `authenticated`).

    VaultState:
      type: string
      enum:
        - setup_required
        - sealed
        - unsealed

    VaultUser:
      type: object
      required:
        - username
      properties:
        username:
          type: string
        created_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp the user record was created, when available.

    VaultStatus:
      type: object
      required:
        - state
      properties:
        state:
          $ref: '#/components/schemas/VaultState'
        user:
          $ref: '#/components/schemas/VaultUser'
          nullable: true
          description: Present once setup is complete.
        sealed_at:
          type: string
          format: date-time
          nullable: true
          description: Last time the vault entered the sealed state.
        unsealed_at:
          type: string
          format: date-time
          nullable: true
          description: Last time the vault was unsealed.
        session_expires_at:
          type: string
          format: date-time
          nullable: true
          description: Session expiry for the current user when unsealed.

    VaultEncryptedPayload:
      type: object
      required:
        - version
        - ciphertext
        - nonce
      properties:
        version:
          type: string
          description: Payload version label used to interpret the ciphertext.
        ciphertext:
          type: string
          format: byte
          description: >
            Base64-encoded ciphertext produced by the browser. When decrypted it
            yields a `VaultSecretsBundle`.
        nonce:
          type: string
          format: byte
          description: Base64-encoded nonce/IV used during encryption.
        associated_data:
          type: string
          format: byte
          nullable: true
          description: Optional associated data supplied during encryption.
        prf_params:
          type: object
          additionalProperties: true
          nullable: true
          description: WebAuthn PRF parameters needed for future decryptions.
    VaultSecretsBundle:
      type: object
      description: >
        JSON structure encrypted during setup and supplied in plaintext when
        unsealing the vault.
      required:
        - not_secret
        - secrets
      properties:
        not_secret:
          type: object
          required:
            - username
          properties:
            username:
              type: string
              description: Logical username mirrored inside the plaintext payload.
        secrets:
          type: object
          required:
            - THREECOMMAS_API_KEY
            - THREECOMMAS_PRIVATE_KEY
            - HYPERLIQUID_WALLET
            - HYPERLIQUID_PRIVATE_KEY
            - HYPERLIQUID_URL
          properties:
            THREECOMMAS_API_KEY:
              type: string
              description: Public API key for the 3Commas integration.
            THREECOMMAS_PRIVATE_KEY:
              type: string
              description: Private API key for the 3Commas integration.
            HYPERLIQUID_WALLET:
              type: string
              description: Hyperliquid wallet address.
            HYPERLIQUID_PRIVATE_KEY:
              type: string
              description: Hyperliquid private key corresponding to the wallet.
            HYPERLIQUID_URL:
              type: string
              description: Hyperliquid URL, mainnet https://api.hyperliquid.xyz testnet https://api.hyperliquid-testnet.xyz or custom

    VaultSetupRequest:
      type: object
      required:
        - username
        - payload
      properties:
        username:
          type: string
          description: Logical username for the vault owner.
        payload:
          $ref: '#/components/schemas/VaultEncryptedPayload'

    VaultUnsealRequest:
      type: object
      required:
        - payload
      properties:
        payload:
          $ref: '#/components/schemas/VaultSecretsBundle'
        remember_session_seconds:
          type: integer
          format: int64
          minimum: 0
          description: Optional session TTL hint; server may clamp or ignore.

    
    BotRecord:
      type: object
      required:
        - bot_id
        - last_synced_at
        - payload
      properties:
        bot_id:
          type: integer
          format: int64
        last_synced_at:
          type: string
          format: date-time
        payload:
          $ref: ../3commas/openapi.yaml#/components/schemas/Bot
          description: Raw 3Commas bot payload exactly as stored.

    DealRecord:
      type: object
      required:
        - deal_id
        - bot_id
        - created_at
        - updated_at
        - payload
      properties:
        deal_id:
          type: integer
          format: int64
        bot_id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        payload:
          $ref: ../3commas/openapi.yaml#/components/schemas/Deal
          description: Raw 3Commas deal payload exactly as stored.

    OrderRecord:
      type: object
      required:
        - metadata_hex
        - bot_id
        - deal_id
        - bot_event_id
        - created_at
        - observed_at
        - bot_event_payload
      properties:
        metadata_hex:
          type: string
        bot_id:
          type: integer
          format: int64
        deal_id:
          type: integer
          format: int64
        bot_event_id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        observed_at:
          type: string
          format: date-time
        bot_event_payload:
          type: object
          additionalProperties: true
          description: Raw payload from `threecommas_botevents`.
        latest_submission:
          type: object
          additionalProperties: true
          nullable: true
          description: >
            Raw JSON from `hyperliquid_submissions` for this metadata (last write wins).
        latest_status:
          type: object
          additionalProperties: true
          nullable: true
          description: >
            Raw JSON from the most recent `hyperliquid_status_history` row for this metadata.
        log_entries:
          type: array
          nullable: true
          description: Present only when `include_log=true`. Entries are filtered to the same metadata/time window.
          items:
            $ref: '#/components/schemas/OrderLogEntry'

    OrderLogEntry:
      type: object
      required:
        - type
        - metadata_hex
        - observed_at
        - payload
      properties:
        type:
          type: string
          enum:
            - three_commas_event
            - hyperliquid_submission
            - hyperliquid_status
        metadata_hex:
          type: string
        bot_event_id:
          type: integer
          format: int64
          nullable: true
          description: Bot-event ID when available (present for 3Commas rows).
        observed_at:
          type: string
          format: date-time
        payload:
          type: object
          additionalProperties: true
          description: Raw JSON payload from the corresponding table.
