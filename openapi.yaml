openapi: 3.0.3
info:
  title: Recomma Ops API
  version: 0.2.1
  license:
    name: Apache 2.0
    url: https://github.com/recomma/recomma/blob/main/LICENSE.txt

servers:
  - url: http://localhost:8080
security:
  - SessionCookie: []
paths:
  /webauthn/registration/begin:
    post:
      operationId: beginWebauthnRegistration
      summary: Begin WebAuthn registration
      description: >
        Issues a WebAuthn credential creation challenge for the supplied username. Clients must
        pass the returned options to `navigator.credentials.create` and later submit the authenticator
        response to `/webauthn/registration/finish`.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnRegistrationBeginRequest'
      responses:
        '200':
          description: Registration ceremony started; includes session token and creation options.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnRegistrationBeginResponse'
        '400':
          description: Invalid payload
        '409':
          description: Registration not allowed in current vault state
        '500':
          description: Internal server error

  /webauthn/registration/finish:
    post:
      operationId: finishWebauthnRegistration
      summary: Complete WebAuthn registration
      description: >
        Validates the WebAuthn attestation returned by the authenticator and stores the credential for
        the vault user. The supplied session token must match a previous registration begin call.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnRegistrationFinishRequest'
      responses:
        '200':
          description: Registration completed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnRegistrationFinishResponse'
        '400':
          description: Invalid attestation payload
        '404':
          description: Registration session not found or expired
        '409':
          description: Registration not allowed in current vault state
        '500':
          description: Internal server error

  /webauthn/login/begin:
    post:
      operationId: beginWebauthnLogin
      summary: Begin WebAuthn assertion
      description: >
        Issues a WebAuthn assertion challenge for the supplied username. Clients must forward the
        returned options to `navigator.credentials.get` and later submit the authenticator response to
        `/webauthn/login/finish`.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnLoginBeginRequest'
      responses:
        '200':
          description: Login ceremony started; includes session token and assertion options.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnLoginBeginResponse'
        '400':
          description: Invalid payload
        '404':
          description: No WebAuthn credentials available for the user
        '409':
          description: Login not allowed in current vault state
        '500':
          description: Internal server error

  /webauthn/login/finish:
    post:
      operationId: finishWebauthnLogin
      summary: Complete WebAuthn assertion
      description: >
        Validates the WebAuthn assertion and issues an authenticated session cookie for the vault endpoints.
        The supplied session token must match a previous login begin call.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnLoginFinishRequest'
      responses:
        '200':
          description: Login completed successfully; session cookie returned.
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Session cookie (`recomma_session`) representing the authenticated user.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnLoginFinishResponse'
        '400':
          description: Invalid assertion payload
        '404':
          description: Login session not found or expired
        '409':
          description: Login not allowed in current vault state
        '500':
          description: Internal server error
  /vault/status:
    get:
      security: []
      operationId: getVaultStatus
      summary: Inspect vault state
      description: >
        Returns the current vault lifecycle state plus meta data about the active user
        and session. This endpoint is unauthenticated so the frontend can poll during setup.
      responses:
        '200':
          description: Current vault status.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '500':
          description: Internal server error

  /vault/setup:
    post:
      security: []
      operationId: setupVault
      summary: Store the encrypted vault payload
      description: >
        Accepts the username and WebAuthn PRF-encrypted secret bundle produced by the browser.
        After storing the payload the vault transitions to the sealed state and awaits unseal.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VaultSetupRequest'
      responses:
        '201':
          description: Vault payload stored; service is sealed and ready for unseal.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '400':
          description: Invalid payload; rejected.
        '409':
          description: Vault is already initialized; switch to recovery flow.
        '500':
          description: Internal server error

  /vault/unseal:
    post:
      security: []
      operationId: unsealVault
      summary: Provide decrypted secrets to unlock the vault
      description: >
        Accepts the plaintext bundle derived in the browser after WebAuthn verification.
        On success the server hydrates upstream clients, issues a session cookie, and marks
        the vault as unsealed until the session expires or `/vault/seal` is called.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VaultUnsealRequest'
      responses:
        '200':
          description: Vault unsealed; session cookie returned.
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Session cookie (`recomma_session`) representing the authenticated user.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '400':
          description: Payload rejected.
        '409':
          description: Vault must be sealed before unsealing.
        '423':
          description: Initial setup is still required.
        '500':
          description: Internal server error

  /vault/seal:
    post:
      operationId: sealVault
      summary: Reseal the vault and clear in-memory secrets
      description: >
        Marks the vault as sealed, drops in-memory credentials, and invalidates the current session.
      responses:
        '200':
          description: Vault sealed; upstream activity should pause until unsealed again.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultStatus'
        '401':
          description: Authentication required.
        '500':
          description: Internal server error
      security:
        - SessionCookie: []

  /vault/payload:
    get:
      operationId: getVaultPayload
      summary: Retrieve encrypted vault payload
      description: >
        Returns the stored ciphertext bundle for the authenticated user. Requires a
        valid session cookie obtained via WebAuthn and is typically called immediately
        before `/vault/unseal`.
      responses:
        '200':
          description: Ciphertext payload available for decryption in the browser.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VaultEncryptedPayload'
        '401':
          description: Authentication required.
        '404':
          description: No vault payload stored yet (setup required or recovery mode).
        '423':
          description: Vault is not yet initialized; run `/vault/setup` first.
        '500':
          description: Internal server error
      security:
        - SessionCookie: []

    put:
      operationId: updateVaultPayload
      summary: Update encrypted vault payload
      description: |
        Replaces the encrypted vault payload with a new version. Requires an active
        WebAuthn session and unsealed vault state. The server validates the decrypted
        payload before persisting the encrypted version. After update, the vault remains
        unsealed but the new configuration is not active until seal/re-unseal cycle.
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - encrypted_payload
                - decrypted_payload
              properties:
                encrypted_payload:
                  $ref: '#/components/schemas/VaultEncryptedPayload'
                  description: Encrypted payload to persist
                decrypted_payload:
                  $ref: '#/components/schemas/VaultSecretsBundle'
                  description: Decrypted payload for server-side validation
      responses:
        '200':
          description: Payload updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Vault payload updated successfully"
        '400':
          description: Invalid payload or validation failed
        '401':
          description: Missing or invalid session
        '403':
          description: Vault is sealed or session expired
        '500':
          description: Internal server error

  /system/status:
    get:
      operationId: getSystemStatus
      summary: Get current system health and status
      description: |
        Polling endpoint for system health. Returns current status of 3commas API,
        Hyperliquid venues, and engine state. Suitable for container health checks.
      responses:
        '200':
          description: Current system status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatus'
        '500':
          description: Internal server error

  /stream/system:
    get:
      operationId: streamSystemEvents
      summary: Server-sent events for system notifications
      description: |
        Real-time stream of system events (errors, warnings, info, logs).
        Events are filtered by server-side log level configuration.
      responses:
        '200':
          description: SSE stream of system events
          content:
            text/event-stream:
              schema:
                type: string
        '500':
          description: Internal server error

  /api/bots:
    get:
      operationId: listBots
      summary: List cached 3Commas bots
      description: >
        Returns bot records stored in `threecommas_bots`. Use filters to drill down
        to a single bot if needed.
      parameters:
        - name: bot_id
          in: query
          description: Return only the bot with this ID (exact match).
          required: false
          schema:
            type: integer
            format: int64
        - name: updated_from
          in: query
          description: ISO-8601 timestamp; include bots touched at or after this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: updated_to
          in: query
          description: ISO-8601 timestamp; include bots touched at or before this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of rows (default 100, max 500).
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 500
        - name: page_token
          in: query
          description: Opaque cursor returned by a previous call (empty for first page).
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Bot records ordered newest-first unless a chronological range was requested.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/BotRecord'
                  next_page_token:
                    type: string
                    nullable: true
                required:
                  - items
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /api/deals:
    get:
      operationId: listDeals
      summary: List cached 3Commas deals
      description: >
        Returns deal rows from `threecommas_deals`. Filters allow narrowing by bot,
        deal ID, and update timestamps; a single endpoint covers both list and detail use-cases.
      parameters:
        - name: deal_id
          in: query
          description: Return only the deal with this ID (exact match).
          required: false
          schema:
            type: integer
            format: int64
        - name: bot_id
          in: query
          description: Restrict to deals belonging to this bot.
          required: false
          schema:
            type: integer
            format: int64
        - name: updated_from
          in: query
          description: ISO-8601 timestamp; include deals updated at or after this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: updated_to
          in: query
          description: ISO-8601 timestamp; include deals updated at or before this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of rows (default 100, max 500).
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 500
        - name: page_token
          in: query
          description: Opaque cursor returned by a previous call.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Deal records ordered newest-first unless a chronological range was requested.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DealRecord'
                  next_page_token:
                    type: string
                    nullable: true
                required:
                  - items
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /api/orders:
    get:
      operationId: listOrders
      summary: List acted-on bot events with Hyperliquid context
      description: >
        Returns rows from `threecommas_botevents` (the actionable subset). Each row includes the raw
        3Commas payload, plus the latest matching submission and status from Hyperliquid if present.
        Use the filters to drill down to a single OrderId hex, bot, deal, or bot-event ID.
        The `from`/`to` window operates on the bot-event `observed_at` timestamp so you can page through history.
        Setting `include_log=true` embeds matching entries from `threecommas_botevents_log` and
        `hyperliquid_status_history` within each result, filtered by the same time window.
      parameters:
        - name: order_id
          in: query
          description: Case-insensitive prefix match on OrderId hex; exact match recommended for drill-down.
          required: false
          schema:
            type: string
        - name: bot_id
          in: query
          description: Restrict to events emitted by this bot ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: deal_id
          in: query
          description: Restrict to events emitted by this deal ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: bot_event_id
          in: query
          description: Restrict to a specific 3Commas bot-event ID (exact match).
          required: false
          schema:
            type: integer
            format: int64
        - name: observed_from
          in: query
          description: ISO-8601 timestamp; include events observed at or after this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: observed_to
          in: query
          description: ISO-8601 timestamp; include events observed at or before this time.
          required: false
          schema:
            type: string
            format: date-time
        - name: include_log
          in: query
          description: >
            When true, embed `log_entries` for each order, limited to the same OrderId and
            time range (default false).
          required: false
          schema:
            type: boolean
        - name: limit
          in: query
          description: Maximum number of rows (default 100, max 500).
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 500
        - name: page_token
          in: query
          description: Opaque cursor returned by a previous call.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Order records matching the requested filters.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderRecord'
                  next_page_token:
                    type: string
                    nullable: true
                required:
                  - items
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /api/orders/scalers:
    get:
      operationId: listOrderScalers
      summary: List effective order scaler configurations for observed OrderId
      description: >
        Returns the effective multiplier applied to each OrderId tuple that has interacted with
        the scaler subsystem. The response resolves bot-level overrides against the global default
        multiplier and surfaces the source OrderId (default vs. override) along with operator notes.
        Use the filters to scope results to a OrderId prefix, bot, deal, or bot-event identifier.
      parameters:
        - name: order_id
          in: query
          description: Case-insensitive prefix match on OrderId hex; exact match recommended for drill-down.
          required: false
          schema:
            type: string
        - name: bot_id
          in: query
          description: Restrict to OrderId emitted by this bot ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: deal_id
          in: query
          description: Restrict to OrderId emitted by this deal ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: bot_event_id
          in: query
          description: Restrict to a specific 3Commas bot-event ID (exact match).
          required: false
          schema:
            type: integer
            format: int64
        - name: limit
          in: query
          description: Maximum number of rows (default 100, max 500).
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 500
        - name: page_token
          in: query
          description: Opaque cursor returned by a previous call.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Effective multiplier records matching the requested filters.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderScalerConfigRecord'
                  next_page_token:
                    type: string
                    nullable: true
                required:
                  - items
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /api/venues:
    get:
      operationId: listVenues
      summary: List configured venues
      description: >
        Returns the inventory of venues available to the runtime. Each venue describes the
        upstream connector, wallet, and optional feature flags applied when dispatching work.
      responses:
        '200':
          description: Venue records ordered by venue identifier.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/VenueRecord'
                required:
                  - items
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error

  /api/venues/{venue_id}:
    put:
      operationId: upsertVenue
      summary: Create or update a venue definition
      description: >
        Inserts or updates a venue record. Venue identifiers are immutable and must be unique.
        Updating a venue overwrites the display name, wallet, and flags with the supplied payload.
      parameters:
        - name: venue_id
          in: path
          required: true
          description: Stable venue identifier.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VenueUpsertRequest'
      responses:
        '200':
          description: Venue stored successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VenueRecord'
        '400':
          description: Invalid payload or venue identifier.
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error
    delete:
      operationId: deleteVenue
      summary: Remove a venue definition
      description: >
        Deletes the venue and any associated assignments. Existing submissions remain in history
        but new work will no longer target the deleted venue.
      parameters:
        - name: venue_id
          in: path
          required: true
          description: Stable venue identifier.
          schema:
            type: string
      responses:
        '204':
          description: Venue removed.
        '400':
          description: Invalid venue identifier.
        '401':
          description: Missing or invalid session.
        '404':
          description: Venue not found.
        '409':
          description: Venue cannot be removed due to existing runtime constraints.
        '500':
          description: Internal server error

  /api/venues/{venue_id}/assignments:
    get:
      operationId: listVenueAssignments
      summary: List bot assignments for a venue
      description: >
        Returns all bot assignments targeting the requested venue. Each entry indicates whether the
        venue is the primary destination for the bot.
      parameters:
        - name: venue_id
          in: path
          required: true
          description: Stable venue identifier.
          schema:
            type: string
      responses:
        '200':
          description: Bot assignments ordered by bot identifier.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/VenueAssignmentRecord'
                required:
                  - items
        '400':
          description: Invalid venue identifier.
        '401':
          description: Missing or invalid session.
        '404':
          description: Venue not found.
        '500':
          description: Internal server error

  /api/venues/{venue_id}/assignments/{bot_id}:
    put:
      operationId: upsertVenueAssignment
      summary: Assign a bot to a venue
      description: >
        Creates or updates the bot-to-venue assignment. Marking an assignment as primary demotes
        any existing primary mapping for the bot.
      parameters:
        - name: venue_id
          in: path
          required: true
          description: Stable venue identifier.
          schema:
            type: string
        - name: bot_id
          in: path
          required: true
          description: 3Commas bot identifier.
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VenueAssignmentUpsertRequest'
      responses:
        '200':
          description: Assignment stored successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VenueAssignmentRecord'
        '400':
          description: Invalid bot or venue identifier.
        '401':
          description: Missing or invalid session.
        '404':
          description: Venue not found.
        '500':
          description: Internal server error
    delete:
      operationId: deleteVenueAssignment
      summary: Remove a bot assignment from a venue
      description: >
        Deletes the assignment linking the bot to the venue.
      parameters:
        - name: venue_id
          in: path
          required: true
          description: Stable venue identifier.
          schema:
            type: string
        - name: bot_id
          in: path
          required: true
          description: 3Commas bot identifier.
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Assignment removed.
        '400':
          description: Invalid bot or venue identifier.
        '401':
          description: Missing or invalid session.
        '404':
          description: Assignment not found.
        '500':
          description: Internal server error

  /api/bots/{bot_id}/venues:
    get:
      operationId: listBotVenues
      summary: List venue assignments for a bot
      description: >
        Returns all venue assignments configured for the supplied bot identifier. When no explicit
        assignment exists the response contains the default Hyperliquid venue.
      parameters:
        - name: bot_id
          in: path
          required: true
          description: 3Commas bot identifier.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Venue assignments ordered by venue identifier.
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/BotVenueAssignmentRecord'
                required:
                  - items
        '400':
          description: Invalid bot identifier.
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error

  /api/v1/order-scaler:
    get:
      operationId: getOrderScalerConfig
      summary: Retrieve the global order scaler multiplier
      description: >
        Returns the current default multiplier applied to all mirrored orders when no per-bot override exists.
        The response includes the underlying configuration record and the effective multiplier OrderId that
        downstream components apply.
      security:
        - SessionCookie: []
      responses:
        '200':
          description: Global order scaler configuration.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderScalerConfigResponse'
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error
    put:
      operationId: updateOrderScalerConfig
      summary: Update the global order scaler multiplier
      description: >
        Sets the default multiplier applied to mirrored orders. The request is idempotentâ€”replaying the same value
        yields the identical response. Multipliers must be greater than zero and cannot exceed the configured maximum.
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderScalerUpdateRequest'
      responses:
        '200':
          description: Updated global order scaler configuration.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderScalerConfigResponse'
        '400':
          description: Invalid multiplier or payload.
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error

  /api/v1/bots/{botId}/order-scaler:
    get:
      operationId: getBotOrderScalerConfig
      summary: Retrieve the effective order scaler for a bot
      description: >
        Returns the global default, any persisted override, and the effective multiplier applied to orders emitted
        by the specified bot.
      security:
        - SessionCookie: []
      parameters:
        - name: botId
          in: path
          required: true
          description: 3Commas bot identifier.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Order scaler configuration for the requested bot.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BotOrderScalerConfigResponse'
        '400':
          description: Invalid bot identifier.
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error
    put:
      operationId: upsertBotOrderScalerConfig
      summary: Upsert a bot-specific order scaler override
      description: >
        Creates or updates the override multiplier for the supplied bot. Supplying the same multiplier repeatedly is
        idempotent. Multipliers must be greater than zero and cannot exceed the configured maximum.
      security:
        - SessionCookie: []
      parameters:
        - name: botId
          in: path
          required: true
          description: 3Commas bot identifier.
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderScalerUpdateRequest'
      responses:
        '200':
          description: Updated bot-level order scaler configuration.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BotOrderScalerConfigResponse'
        '400':
          description: Invalid bot identifier or multiplier.
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error
    delete:
      operationId: deleteBotOrderScalerConfig
      summary: Delete a bot-specific order scaler override
      description: >
        Removes the override for the supplied bot and immediately reverts to the global default multiplier. The operation
        is idempotent and returns the effective configuration after deletion.
      security:
        - SessionCookie: []
      parameters:
        - name: botId
          in: path
          required: true
          description: 3Commas bot identifier.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Effective configuration after removing the override.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BotOrderScalerConfigResponse'
        '400':
          description: Invalid bot identifier.
        '401':
          description: Missing or invalid session.
        '500':
          description: Internal server error

  /api/orders/{order_id}/cancel:
    post:
      operationId: cancelOrderByOrderId
      summary: Cancel Hyperliquid order by OrderId
      description: >
        Enqueues a Hyperliquid cancel action for the order identified by the supplied OrderId hex.
        The service resolves the most recent submission for the OrderId to determine the CLOID and venue coin.
      parameters:
        - name: order_id
          in: path
          required: true
          description: Order OrderId identifier (case-insensitive hex string with optional `0x` prefix).
          schema:
            type: string
        - name: venue_id
          in: query
          required: false
          description: Optional venue selector. When provided the cancel is limited to submissions recorded for this venue.
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelOrderByOrderIdRequest'
      responses:
        '202':
          description: Cancel action accepted for processing.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelOrderByOrderIdResponse'
        '400':
          description: Invalid OrderId or payload
        '404':
          description: OrderId not found or no cancellable order present
        '409':
          description: Order already completed or cancel currently in progress
        '500':
          description: Internal server error

  /sse/orders:
    get:
      operationId: streamOrders
      summary: Stream live changes to acted-on orders
      description: >
        Server Sent Events channel fed by writes to `threecommas_botevents`, `hyperliquid_submissions`,
        and `hyperliquid_status_history`. Each `data:` frame is a JSON object containing the raw payload
        we stored for that update, plus the OrderId hex and timestamps. Filters match the query semantics
        of `/api/orders`.
      parameters:
        - name: order_id
          in: query
          description: Case-insensitive prefix match; only events for matching OrderId are emitted.
          required: false
          schema:
            type: string
        - name: bot_id
          in: query
          description: Restrict to this bot ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: deal_id
          in: query
          description: Restrict to this deal ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: bot_event_id
          in: query
          description: Restrict to this bot-event ID.
          required: false
          schema:
            type: integer
            format: int64
        - name: observed_from
          in: query
          description: If supplied, drop events older than this timestamp (useful for resume).
          required: false
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: text/event-stream; each frame carries a JSON object with order-change details.
          content:
            text/event-stream:
              schema:
                type: string
                description: >
                  UTF-8 event stream. Example frames:
                  ```
                  event: three_commas_event
                  data: {"type":"three_commas_event","order_id":"0x1234","identifiers":{"hex":"0x1234","bot_id":16538545,"deal_id":2381631392,"bot_event_id":1917367905,"created_at":"2025-01-02T01:02:03Z","venue_id":"hyperliquid:primary","wallet":"0xabc"},"observed_at":"2025-01-02T03:04:05Z","event":{"created_at":"2025-01-02T01:02:03Z","action":"Placing","coin":"DOGE","type":"BUY","status":"Active","price":0.19788,"size":105,"order_type":"base","order_size":0,"order_position":0,"quote_volume":20.7774,"quote_currency":"USDT","is_market":false,"text":"Placing base order..."}}

                  event: order_scaler_config
                  data: {"type":"order_scaler_config","order_id":"0x1234","observed_at":"2025-01-02T03:04:05Z","config":{"order_id":"0x1234","multiplier":0.5,"source":"bot_override","default":{"multiplier":1.0,"updated_at":"2025-01-01T00:00:00Z","updated_by":"system"},"override":{"bot_id":16538545,"multiplier":0.5,"notes":"risk off","effective_from":"2025-01-02T03:04:05Z","updated_at":"2025-01-02T03:04:05Z","updated_by":"operator"}},"actor":"operator"}

                  ```
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

  /sse/hyperliquid/prices:
    get:
      operationId: streamHyperliquidPrices
      summary: Stream Hyperliquid best bid/offer quotes
      description: >
        Server Sent Events channel that publishes best bid and offer updates for the requested Hyperliquid coins.
        Each subscription ensures the backend is listening to the venue's BBO feed (via `EnsureBBO`) and forwards
        normalized price levels whenever new quotes arrive. Each `data:` payload is a JSON-encoded
        `HyperliquidBestBidOffer`.
      parameters:
        - name: coin
          in: query
          required: true
          description: >
            One or more Hyperliquid coin tickers to subscribe to. Repeat the parameter to request multiple coins.
          schema:
            type: array
            items:
              type: string
            minItems: 1
      responses:
        '200':
          description: text/event-stream; each frame encodes the latest best bid/offer snapshot for the subscribed coins.
          content:
            text/event-stream:
              schema:
                type: string
                description: >
                  UTF-8 event stream. Frames use `event: bbo` and `data:` to carry JSON payloads.
                  ```
                  event: bbo
                  data: {"coin":"ETH","time":"2025-01-02T03:04:05Z","bid":{"price":2123.45,"size":1.2},"ask":{"price":2123.55,"size":0.9}}
                  
                  ```
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error

components:
  securitySchemes:
    SessionCookie:
      type: apiKey
      in: cookie
      name: recomma_session
      description: Session cookie issued after a successful `/vault/unseal`.

  schemas:
    WebAuthnRegistrationBeginRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          description: Logical username initiating registration.

    WebAuthnRegistrationBeginResponse:
      type: object
      required:
        - session_token
        - creation_options
      properties:
        session_token:
          type: string
          description: Opaque token that must be supplied when completing registration.
        creation_options:
          type: object
          additionalProperties: true
          description: PublicKeyCredentialCreationOptions for `navigator.credentials.create`.

    WebAuthnRegistrationFinishRequest:
      type: object
      required:
        - session_token
        - client_response
      properties:
        session_token:
          type: string
          description: Token issued by `/webauthn/registration/begin`.
        client_response:
          type: object
          additionalProperties: true
          description: Parsed response from `navigator.credentials.create`.

    WebAuthnRegistrationFinishResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Textual status of the registration ceremony (for example `registered`).

    WebAuthnLoginBeginRequest:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          description: Logical username initiating the login ceremony.

    WebAuthnLoginBeginResponse:
      type: object
      required:
        - session_token
        - assertion_options
      properties:
        session_token:
          type: string
          description: Opaque token that must be supplied when completing login.
        assertion_options:
          type: object
          additionalProperties: true
          description: PublicKeyCredentialRequestOptions for `navigator.credentials.get`.

    WebAuthnLoginFinishRequest:
      type: object
      required:
        - session_token
        - client_response
      properties:
        session_token:
          type: string
          description: Token issued by `/webauthn/login/begin`.
        client_response:
          type: object
          additionalProperties: true
          description: Parsed response from `navigator.credentials.get`.

    WebAuthnLoginFinishResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Textual status of the login ceremony (for example `authenticated`).

    VaultState:
      type: string
      enum:
        - setup_required
        - sealed
        - unsealed

    VaultUser:
      type: object
      required:
        - username
      properties:
        username:
          type: string
        created_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp the user record was created, when available.

    VaultStatus:
      type: object
      required:
        - state
      properties:
        state:
          $ref: '#/components/schemas/VaultState'
        user:
          $ref: '#/components/schemas/VaultUser'
          nullable: true
          description: Present once setup is complete.
        sealed_at:
          type: string
          format: date-time
          nullable: true
          description: Last time the vault entered the sealed state.
        unsealed_at:
          type: string
          format: date-time
          nullable: true
          description: Last time the vault was unsealed.
        session_expires_at:
          type: string
          format: date-time
          nullable: true
          description: Session expiry for the current user when unsealed.
        debug_mode:
          type: boolean
          description: Indicates whether the server is running in debug mode.

    VaultEncryptedPayload:
      type: object
      required:
        - version
        - ciphertext
        - nonce
      properties:
        version:
          type: string
          description: Payload version label used to interpret the ciphertext.
        ciphertext:
          type: string
          format: byte
          description: >
            Base64-encoded ciphertext produced by the browser. When decrypted it
            yields a `VaultSecretsBundle`.
        nonce:
          type: string
          format: byte
          description: Base64-encoded nonce/IV used during encryption.
        associated_data:
          type: string
          format: byte
          nullable: true
          description: Optional associated data supplied during encryption.
        prf_params:
          type: object
          additionalProperties: true
          nullable: true
          description: WebAuthn PRF parameters needed for future decryptions.
    VaultSecretsBundle:
      type: object
      description: >
        JSON structure encrypted during setup and supplied in plaintext when
        unsealing the vault.
      required:
        - not_secret
        - secrets
      properties:
        not_secret:
          $ref: '#/components/schemas/VaultSecretsBundleNotSecret'
        secrets:
          $ref: '#/components/schemas/VaultSecretsBundleSecrets'

    VaultVenueSecret:
      type: object
      required:
        - id
        - type
        - wallet
        - private_key
        - is_primary
      properties:
        id:
          type: string
          description: Unique identifier for the venue.
        type:
          type: string
          description: Connector type backing the venue (for example `hyperliquid`).
        display_name:
          type: string
          description: Human readable venue label.
        wallet:
          type: string
          description: Wallet address used for submissions to this venue.
        private_key:
          type: string
          description: Secret key associated with the configured wallet.
        api_url:
          type: string
          nullable: true
          description: Optional API base URL for the venue.
        flags:
          type: object
          nullable: true
          additionalProperties: true
          description: Connector specific options encoded alongside the venue metadata.
        is_primary:
          type: boolean
          description: Indicates whether this venue should be treated as primary.

    VaultSetupRequest:
      type: object
      required:
        - username
        - payload
      properties:
        username:
          type: string
          description: Logical username for the vault owner.
        payload:
          $ref: '#/components/schemas/VaultEncryptedPayload'

    VaultUnsealRequest:
      type: object
      required:
        - payload
      properties:
        payload:
          $ref: '#/components/schemas/VaultSecretsBundle'
        remember_session_seconds:
          type: integer
          format: int64
          minimum: 0
          description: Optional session TTL hint; server may clamp or ignore.

    
    BotRecord:
      type: object
      required:
        - bot_id
        - last_synced_at
        - payload
      properties:
        bot_id:
          type: integer
          format: int64
        last_synced_at:
          type: string
          format: date-time
        payload:
          $ref: 3commas-openapi/3commas/openapi.yaml#/components/schemas/Bot
          description: Raw 3Commas bot payload exactly as stored.

    DealRecord:
      type: object
      required:
        - deal_id
        - bot_id
        - created_at
        - updated_at
        - payload
      properties:
        deal_id:
          type: integer
          format: int64
        bot_id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        payload:
          $ref: 3commas-openapi/3commas/openapi.yaml#/components/schemas/Deal
          description: Raw 3Commas deal payload exactly as stored.

    OrderRecord:
      type: object
      required:
        - order_id
        - identifiers
        - observed_at
        - three_commas
      properties:
        order_id:
          type: string
          description: OrderId hash (hex) as stored in `threecommas_botevents`.
        identifiers:
          $ref: '#/components/schemas/OrderIdentifiers'
          description: Parsed bot/deal information derived from the OrderId. `hex` repeats the `OrderId` value.
        observed_at:
          type: string
          format: date-time
          description: Timestamp when Recomma observed the order update.
        three_commas:
          $ref: '#/components/schemas/ThreeCommasOrderState'
          description: Latest parsed 3Commas bot-event associated with this OrderId.
        hyperliquid:
          $ref: '#/components/schemas/HyperliquidOrderState'
          nullable: true
          description: Latest Hyperliquid submission/status captured for this OrderId.
        log_entries:
          type: array
          nullable: true
          description: Present only when `include_log=true`. Entries follow the same structured shape as the SSE stream.
          items:
            $ref: '#/components/schemas/OrderLogEntry'

    CancelOrderByOrderIdRequest:
      type: object
      properties:
        reason:
          type: string
          nullable: true
          description: Optional operator note recorded alongside the cancel request.
        dry_run:
          type: boolean
          description: >
            When true, validate the cancel preconditions without dispatching the Hyperliquid request.
          default: false
      additionalProperties: false

    CancelOrderByOrderIdResponse:
      type: object
      required:
        - order_id
        - status
      properties:
        order_id:
          type: string
          description: OrderID hex identifying the targeted order.
        status:
          type: string
          description: Outcome of the cancel attempt (for example `queued`, `skipped`, or `noop`).
        cancel:
          $ref: '#/components/schemas/HyperliquidCancelOrder'
          nullable: true
          description: Hyperliquid cancel payload that will be submitted when applicable.
        message:
          type: string
          nullable: true
          description: Additional context explaining the status when relevant.
      additionalProperties: false

    OrderIdentifiers:
      type: object
      required:
        - hex
        - bot_id
        - deal_id
        - bot_event_id
        - created_at
        - venue_id
        - wallet
      properties:
        hex:
          type: string
          description: Case-insensitive hash deriving from the 3Commas OrderId payload.
        bot_id:
          type: integer
          format: int64
        deal_id:
          type: integer
          format: int64
        bot_event_id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
          description: When the originating 3Commas event was created.
        venue_id:
          type: string
          description: Upstream venue identifier associated with the submission.
        wallet:
          type: string
          description: Wallet address tied to the venue submission.

    ThreeCommasOrderState:
      type: object
      required:
        - event
      properties:
        event:
          $ref: '#/components/schemas/ThreeCommasBotEvent'
          description: Parsed 3Commas bot event emitted for this OrderId.

    ThreeCommasBotEvent:
      type: object
      required:
        - created_at
        - action
        - coin
        - type
        - status
        - price
        - size
        - order_type
        - order_size
        - order_position
        - quote_volume
        - quote_currency
        - is_market
        - text
      properties:
        created_at:
          type: string
          format: date-time
        action:
          type: string
          description: High-level classification provided by the bot event parser (for example `Placing` or `Execute`).
        coin:
          type: string
        type:
          type: string
          description: BUY/SELL side reported by 3Commas.
        status:
          type: string
        price:
          type: number
          format: double
        size:
          type: number
          format: double
        order_type:
          type: string
          description: Event order type from 3Commas (base, safety, take_profit, etc).
        order_size:
          type: integer
          description: Total number of orders in the group this event belongs to.
        order_position:
          type: integer
          description: Position of this event inside the group (1-indexed).
        quote_volume:
          type: number
          format: double
        quote_currency:
          type: string
        is_market:
          type: boolean
        profit:
          type: number
          format: double
          nullable: true
        profit_currency:
          type: string
          nullable: true
        profit_usd:
          type: number
          format: double
          nullable: true
        profit_percentage:
          type: number
          format: double
          nullable: true
        text:
          type: string
          description: Raw message parsed from 3Commas describing the event.

    HyperliquidOrderState:
      type: object
      properties:
        identifier:
          $ref: '#/components/schemas/OrderIdentifiers'
          nullable: true
          description: Identifier describing the venue and wallet for the surfaced submission/status.
        latest_submission:
          $ref: '#/components/schemas/HyperliquidAction'
          nullable: true
          description: Most recent action we submitted to Hyperliquid for this OrderId (last write wins).
        latest_status:
          $ref: '#/components/schemas/HyperliquidWsOrder'
          nullable: true
          description: Most recent order status update received from Hyperliquid for this OrderId.

    HyperliquidAction:
      oneOf:
        - $ref: '#/components/schemas/HyperliquidNoopAction'
        - $ref: '#/components/schemas/HyperliquidCreateAction'
        - $ref: '#/components/schemas/HyperliquidModifyAction'
        - $ref: '#/components/schemas/HyperliquidCancelAction'
      discriminator:
        propertyName: kind
        mapping:
          none: '#/components/schemas/HyperliquidNoopAction'
          create: '#/components/schemas/HyperliquidCreateAction'
          modify: '#/components/schemas/HyperliquidModifyAction'
          cancel: '#/components/schemas/HyperliquidCancelAction'

    HyperliquidActionBase:
      type: object
      required:
        - kind
      properties:
        kind:
          type: string

    HyperliquidNoopAction:
      allOf:
        - $ref: '#/components/schemas/HyperliquidActionBase'
        - type: object
          properties:
            kind:
              type: string
              enum:
                - none
            reason:
              type: string
              nullable: true
              description: Optional explanation when no actionable payload is available.

    HyperliquidCreateAction:
      allOf:
        - $ref: '#/components/schemas/HyperliquidActionBase'
        - type: object
          required:
            - order
          properties:
            kind:
              type: string
              enum:
                - create
            order:
              $ref: '#/components/schemas/HyperliquidCreateOrder'

    HyperliquidModifyAction:
      allOf:
        - $ref: '#/components/schemas/HyperliquidActionBase'
        - type: object
          required:
            - order
          properties:
            kind:
              type: string
              enum:
                - modify
            oid:
              type: integer
              format: int64
              nullable: true
              description: Target order identifier when available.
            cloid:
              type: string
              nullable: true
              description: Client order identifier (CLOID) to target when `oid` is not available.
            order:
              $ref: '#/components/schemas/HyperliquidCreateOrder'
          description: At least one of `oid` or `cloid` must be supplied to identify the order to modify.

    HyperliquidCancelAction:
      allOf:
        - $ref: '#/components/schemas/HyperliquidActionBase'
        - type: object
          required:
            - cancel
          properties:
            kind:
              type: string
              enum:
                - cancel
            cancel:
              $ref: '#/components/schemas/HyperliquidCancelOrder'

    HyperliquidCreateOrder:
      type: object
      required:
        - coin
        - is_buy
        - price
        - size
        - reduce_only
        - order_type
      properties:
        coin:
          type: string
        is_buy:
          type: boolean
        price:
          type: number
          format: double
        size:
          type: number
          format: double
        reduce_only:
          type: boolean
        order_type:
          $ref: '#/components/schemas/HyperliquidOrderType'
        cloid:
          type: string
          nullable: true

    HyperliquidOrderType:
      type: object
      properties:
        limit:
          $ref: '#/components/schemas/HyperliquidLimitOrder'
        trigger:
          $ref: '#/components/schemas/HyperliquidTriggerOrder'
      additionalProperties: false

    HyperliquidLimitOrder:
      type: object
      required:
        - tif
      properties:
        tif:
          type: string
          description: Time in force. Examples include `Gtc`, `Ioc`, and `Alo`.

    HyperliquidTriggerOrder:
      type: object
      required:
        - trigger_px
        - is_market
        - tpsl
      properties:
        trigger_px:
          type: number
          format: double
        is_market:
          type: boolean
        tpsl:
          type: string
          description: Describes whether this trigger is take-profit (`tp`) or stop-loss (`sl`).

    HyperliquidCancelOrder:
      type: object
      required:
        - coin
        - cloid
      properties:
        coin:
          type: string
        cloid:
          type: string

    HyperliquidBestBidOffer:
      type: object
      required:
        - coin
        - time
        - bid
        - ask
      properties:
        coin:
          type: string
          description: Hyperliquid coin ticker (for example `ETH`).
        time:
          type: string
          format: date-time
          description: Timestamp (ISO-8601) when the quote snapshot was observed.
        bid:
          $ref: '#/components/schemas/HyperliquidPriceLevel'
          description: Best bid level reported by Hyperliquid at `time`.
        ask:
          $ref: '#/components/schemas/HyperliquidPriceLevel'
          description: Best ask level reported by Hyperliquid at `time`.

    HyperliquidPriceLevel:
      type: object
      required:
        - price
        - size
      properties:
        price:
          type: number
          format: double
          description: Price level denominated in USD.
        size:
          type: number
          format: double
          description: Available size at this price level.

    HyperliquidWsOrder:
      type: object
      required:
        - order
        - status
        - status_timestamp
      properties:
        order:
          $ref: '#/components/schemas/HyperliquidWsBasicOrder'
        status:
          $ref: '#/components/schemas/HyperliquidOrderStatus'
        status_timestamp:
          type: integer
          format: int64

    HyperliquidWsBasicOrder:
      type: object
      required:
        - coin
        - side
        - limit_px
        - size
        - oid
        - timestamp
        - orig_size
      properties:
        coin:
          type: string
        side:
          type: string
          description: Either `A` (ask) or `B` (bid) in Hyperliquid terminology.
        limit_px:
          type: string
        size:
          type: string
        oid:
          type: integer
          format: int64
        timestamp:
          type: integer
          format: int64
        orig_size:
          type: string
        cloid:
          type: string
          nullable: true

    HyperliquidOrderStatus:
      type: string
      enum:
        - open
        - filled
        - canceled
        - triggered
        - rejected
        - marginCanceled
        - vaultWithdrawalCanceled
        - openInterestCapCanceled
        - selfTradeCanceled
        - reduceOnlyCanceled
        - siblingFilledCanceled
        - delistedCanceled
        - liquidatedCanceled
        - scheduledCancel
        - tickRejected
        - minTradeNtlRejected
        - perpMarginRejected
        - reduceOnlyRejected
        - badAloPxRejected
        - iocCancelRejected
        - badTriggerPxRejected
        - marketOrderNoLiquidityRejected
        - positionIncreaseAtOpenInterestCapRejected
        - positionFlipAtOpenInterestCapRejected
        - tooAggressiveAtOpenInterestCapRejected
        - openInterestIncreaseRejected

    OrderLogEntry:
      oneOf:
        - $ref: '#/components/schemas/ThreeCommasLogEntry'
        - $ref: '#/components/schemas/HyperliquidSubmissionLogEntry'
        - $ref: '#/components/schemas/HyperliquidStatusLogEntry'
        - $ref: '#/components/schemas/OrderScalerConfigLogEntry'
        - $ref: '#/components/schemas/ScaledOrderAuditLogEntry'
      discriminator:
        propertyName: type
        mapping:
          three_commas_event: '#/components/schemas/ThreeCommasLogEntry'
          hyperliquid_submission: '#/components/schemas/HyperliquidSubmissionLogEntry'
          hyperliquid_status: '#/components/schemas/HyperliquidStatusLogEntry'
          order_scaler_config: '#/components/schemas/OrderScalerConfigLogEntry'
          scaled_order_audit: '#/components/schemas/ScaledOrderAuditLogEntry'

    OrderLogEntryBase:
      type: object
      required:
        - type
        - order_id
        - observed_at
      properties:
        type:
          type: string
          enum:
            - three_commas_event
            - hyperliquid_submission
            - hyperliquid_status
            - order_scaler_config
            - scaled_order_audit
        order_id:
          type: string
          description: OrderId hash (hex) identifying the order context.
        identifiers:
          $ref: '#/components/schemas/OrderIdentifiers'
          nullable: true
          description: Bot/deal identifiers derived from the OrderId when available.
        observed_at:
          type: string
          format: date-time
        sequence:
          type: integer
          format: int64
          nullable: true
          description: Monotonic sequence counter assigned at publish time, useful for de-duplicating streamed events.
        bot_event_id:
          type: integer
          format: int64
          nullable: true

    VenueRecord:
      type: object
      required:
        - venue_id
        - type
        - display_name
        - wallet
      properties:
        venue_id:
          type: string
        type:
          type: string
        display_name:
          type: string
        wallet:
          type: string
        flags:
          type: object
          additionalProperties: true
          description: Connector specific options encoded as JSON.

    VenueUpsertRequest:
      type: object
      required:
        - type
        - display_name
        - wallet
      properties:
        type:
          type: string
        display_name:
          type: string
        wallet:
          type: string
        flags:
          type: object
          additionalProperties: true
          nullable: true
          description: Connector specific options encoded as JSON.

    VenueAssignmentRecord:
      type: object
      required:
        - bot_id
        - venue_id
        - is_primary
        - assigned_at
      properties:
        bot_id:
          type: integer
          format: int64
        venue_id:
          type: string
        is_primary:
          type: boolean
        assigned_at:
          type: string
          format: date-time

    VenueAssignmentUpsertRequest:
      type: object
      required:
        - is_primary
      properties:
        is_primary:
          type: boolean

    BotVenueAssignmentRecord:
      type: object
      required:
        - venue_id
        - wallet
        - is_primary
      properties:
        venue_id:
          type: string
        wallet:
          type: string
        is_primary:
          type: boolean

    OrderScalerSource:
      type: string
      enum:
        - default
        - bot_override

    OrderScalerState:
      type: object
      required:
        - multiplier
        - updated_at
        - updated_by
      properties:
        multiplier:
          type: number
          format: double
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: string
        notes:
          type: string
          nullable: true

    OrderScalerEffectiveMultiplier:
      type: object
      required:
        - source
        - value
        - updated_at
        - updated_by
      properties:
        source:
          $ref: '#/components/schemas/OrderScalerSource'
        value:
          type: number
          format: double
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: string
        notes:
          type: string
          nullable: true

    OrderScalerConfigResponse:
      type: object
      required:
        - default
        - effective
      properties:
        default:
          $ref: '#/components/schemas/OrderScalerState'
        effective:
          $ref: '#/components/schemas/OrderScalerEffectiveMultiplier'

    BotOrderScalerConfigResponse:
      type: object
      required:
        - bot_id
        - default
        - effective
      properties:
        bot_id:
          type: integer
          format: int64
        default:
          $ref: '#/components/schemas/OrderScalerState'
        override:
          $ref: '#/components/schemas/OrderScalerOverride'
          nullable: true
        effective:
          $ref: '#/components/schemas/OrderScalerEffectiveMultiplier'

    OrderScalerUpdateRequest:
      type: object
      required:
        - multiplier
      properties:
        multiplier:
          type: number
          format: double
        notes:
          type: string
          nullable: true

    OrderScalerOverride:
      type: object
      required:
        - bot_id
        - updated_at
        - updated_by
        - effective_from
      properties:
        bot_id:
          type: integer
          format: int64
        multiplier:
          type: number
          format: double
          nullable: true
        notes:
          type: string
          nullable: true
        effective_from:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: string

    EffectiveOrderScaler:
      type: object
      required:
        - order_id
        - multiplier
        - source
        - default
      properties:
        order_id:
          type: string
        multiplier:
          type: number
          format: double
        source:
          $ref: '#/components/schemas/OrderScalerSource'
        default:
          $ref: '#/components/schemas/OrderScalerState'
        override:
          $ref: '#/components/schemas/OrderScalerOverride'
          nullable: true

    OrderScalerConfigLogEntry:
      allOf:
        - $ref: '#/components/schemas/OrderLogEntryBase'
        - type: object
          required:
            - config
            - actor
          properties:
            config:
              $ref: '#/components/schemas/EffectiveOrderScaler'
            actor:
              type: string

    OrderScalerConfigRecord:
      type: object
      required:
        - order_id
        - observed_at
        - actor
        - config
      properties:
        order_id:
          type: string
        observed_at:
          type: string
          format: date-time
        actor:
          type: string
        config:
          $ref: '#/components/schemas/EffectiveOrderScaler'

    ScaledOrderAudit:
      type: object
      required:
        - deal_id
        - bot_id
        - original_size
        - scaled_size
        - multiplier
        - rounding_delta
        - stack_index
        - order_side
        - multiplier_updated_by
        - created_at
        - skipped
      properties:
        deal_id:
          type: integer
          format: int64
        bot_id:
          type: integer
          format: int64
        original_size:
          type: number
          format: double
        scaled_size:
          type: number
          format: double
        multiplier:
          type: number
          format: double
        rounding_delta:
          type: number
          format: double
        stack_index:
          type: integer
        order_side:
          type: string
        multiplier_updated_by:
          type: string
        created_at:
          type: string
          format: date-time
        submitted_order_id:
          type: string
          nullable: true
        skipped:
          type: boolean
        skip_reason:
          type: string
          nullable: true

    ScaledOrderAuditLogEntry:
      allOf:
        - $ref: '#/components/schemas/OrderLogEntryBase'
        - type: object
          required:
            - audit
            - actor
          properties:
            audit:
              $ref: '#/components/schemas/ScaledOrderAudit'
            effective:
              $ref: '#/components/schemas/EffectiveOrderScaler'
              nullable: true
            actor:
              type: string

    ThreeCommasLogEntry:
      allOf:
        - $ref: '#/components/schemas/OrderLogEntryBase'
        - type: object
          required:
            - event
          properties:
            event:
              $ref: '#/components/schemas/ThreeCommasBotEvent'

    HyperliquidSubmissionLogEntry:
      allOf:
        - $ref: '#/components/schemas/OrderLogEntryBase'
        - type: object
          required:
            - action
          properties:
            action:
              $ref: '#/components/schemas/HyperliquidAction'

    HyperliquidStatusLogEntry:
      allOf:
        - $ref: '#/components/schemas/OrderLogEntryBase'
        - type: object
          required:
            - status
          properties:
            status:
              $ref: '#/components/schemas/HyperliquidWsOrder'

    SystemStatus:
      type: object
      required:
        - timestamp
        - engine
      properties:
        timestamp:
          type: string
          format: date-time
          description: When this status snapshot was captured
        threecommas_api:
          type: object
          nullable: true
          properties:
            available:
              type: boolean
              description: Whether 3commas API is currently reachable
            last_error:
              type: string
              nullable: true
              description: Most recent error from 3commas API, if any
            last_successful_call:
              type: string
              format: date-time
              nullable: true
              description: Timestamp of last successful 3commas API call
        hyperliquid_venues:
          type: array
          items:
            type: object
            required:
              - venue_id
              - wallet
              - connected
            properties:
              venue_id:
                type: string
                description: Venue identifier
              wallet:
                type: string
                description: Wallet address for this venue
              connected:
                type: boolean
                description: Whether venue websocket/client is connected
              last_error:
                type: string
                nullable: true
                description: Most recent error for this venue
        engine:
          type: object
          required:
            - running
            - active_deals
          properties:
            running:
              type: boolean
              description: Whether the order engine is running
            active_deals:
              type: integer
              description: Number of active deals being tracked
            last_sync:
              type: string
              format: date-time
              nullable: true
              description: Timestamp of last deal sync with 3commas

    SystemEvent:
      type: object
      required:
        - level
        - timestamp
        - source
        - message
      properties:
        level:
          type: string
          enum: [debug, info, warn, error]
          description: Log level matching slog levels
        timestamp:
          type: string
          format: date-time
          description: When this event occurred
        source:
          type: string
          description: Component that emitted the event (e.g., "3commas", "hyperliquid", "engine", "storage")
        message:
          type: string
          description: Human-readable error/info message
        details:
          type: object
          additionalProperties: true
          nullable: true
          description: Structured context (optional)
    VaultSecretsBundleNotSecret:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          description: Logical username mirrored inside the plaintext payload.

    VaultSecretsBundleSecrets:
      type: object
      required:
        - THREECOMMAS_API_KEY
        - THREECOMMAS_PRIVATE_KEY
        - THREECOMMAS_PLAN_TIER
        - venues
      properties:
        THREECOMMAS_API_KEY:
          type: string
          description: Public API key for the 3Commas integration.
        THREECOMMAS_PRIVATE_KEY:
          type: string
          description: Private API key for the 3Commas integration.
        THREECOMMAS_PLAN_TIER:
          type: string
          description: Subscription tier for the 3Commas client rate limits.
          enum:
            - starter
            - pro
            - expert
        venues:
          type: array
          description: Collection of venue credentials encrypted within the vault.
          minItems: 1
          items:
            $ref: '#/components/schemas/VaultVenueSecret'
